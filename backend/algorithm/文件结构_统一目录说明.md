# 文件结构 - 统一目录说明

## 📋 概述

所有与视频处理相关的输出文件都组织在一个统一的大文件夹下，命名格式为 `frames_视频名_时间戳`。这样可以将同一次运行的所有结果集中管理。

## 🕐 时间戳格式

**统一格式**：`YYYYMMDD_HHMMSS`

- **示例**：`20251006_103000`（2025年10月6日 10:30:00）
- **特点**：
  - 易于阅读
  - 文件系统友好（无特殊字符）
  - 可排序（字母顺序即时间顺序）
  - 唯一性（精确到秒）

## 📁 新的文件结构

### 单次运行的完整结构

假设视频文件名为 `minvideo.mp4`，运行时间戳为 `20251006_103000`：

```
output/
└── frames_minvideo_20251006_103000/          # 大文件夹（包含所有输出）
    ├── outline.md                             # 初始大纲
    ├── detailed_outline.md                    # 详细大纲（含匹配文本）
    │
    ├── videocut/                              # 视频切片子目录
    │   ├── 01_项目架构图.mp4
    │   ├── 02_微调模块与Prompt优化模块.mp4
    │   ├── 03_知识库问答流程.mp4
    │   └── ...
    │
    ├── frames_01_项目架构图/                 # 视频1的帧文件夹
    │   ├── frame_0001.jpg
    │   ├── frame_0002.jpg
    │   └── ...
    │
    ├── frames_02_微调模块与Prompt优化模块/   # 视频2的帧文件夹
    │   ├── frame_0001.jpg
    │   ├── frame_0002.jpg
    │   └── ...
    │
    └── frames_03_知识库问答流程/              # 视频3的帧文件夹
        ├── frame_0001.jpg
        ├── frame_0002.jpg
        └── ...
```

## 🆚 新旧结构对比

### 旧结构（分散存储）

```
output/
├── outline_20251006_103000.md
├── detailed_outline_20251006_103000.md
├── videocut_20251006_103000/
│   └── ...
├── frames_01_项目架构图_20251006_103000/
│   └── ...
└── frames_02_微调模块_20251006_103000/
    └── ...
```

**问题**：
- ❌ 文件分散在 output 根目录
- ❌ 需要通过时间戳匹配相关文件
- ❌ 难以一次性打包或清理

### 新结构（集中存储）

```
output/
└── frames_minvideo_20251006_103000/
    ├── outline.md
    ├── detailed_outline.md
    ├── videocut/
    └── frames_XX/
```

**优势**：
- ✅ 所有相关文件集中在一个文件夹
- ✅ 文件夹名包含视频名和时间戳
- ✅ 易于打包、备份、清理
- ✅ 文件名简洁（不再需要时间戳）

## 📊 文件命名规则详解

### 1. 大文件夹命名

**格式**：`frames_视频名_时间戳`

| 组成部分 | 说明 | 示例 |
|---------|------|------|
| `frames_` | 固定前缀，标识这是帧处理输出 | `frames_` |
| 视频名 | 输入视频文件名（不含扩展名） | `minvideo` |
| `_` | 分隔符 | `_` |
| 时间戳 | 运行时间（YYYYMMDD_HHMMSS） | `20251006_103000` |

**完整示例**：`frames_minvideo_20251006_103000`

### 2. 大纲文件命名

| 文件 | 命名 | 位置 |
|------|------|------|
| 初始大纲 | `outline.md` | 大文件夹根目录 |
| 详细大纲 | `detailed_outline.md` | 大文件夹根目录 |

### 3. 视频切片命名

**目录**：`videocut/`（位于大文件夹下）

**文件命名**：`序号_标题.mp4`

| 示例 | 说明 |
|------|------|
| `01_项目架构图.mp4` | 第1个视频片段 |
| `02_微调模块与Prompt优化模块.mp4` | 第2个视频片段 |
| `03_知识库问答流程.mp4` | 第3个视频片段 |

### 4. 帧文件夹命名

**格式**：`frames_视频片段名/`（位于大文件夹下）

| 示例 | 说明 |
|------|------|
| `frames_01_项目架构图/` | 视频1的所有帧 |
| `frames_02_微调模块与Prompt优化模块/` | 视频2的所有帧 |

**帧文件命名**：`frame_序号.jpg`（4位数字，如 `frame_0001.jpg`）

## 🔧 代码实现逻辑

### 主流程（main.py）

```python
def main():
    # 1. 生成时间戳
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    # 2. 提取视频名
    video_name = os.path.splitext(os.path.basename(config.INPUT_VIDEO_PATH))[0]
    
    # 3. 创建大文件夹
    main_output_folder = f"frames_{video_name}_{timestamp}"
    main_output_path = os.path.join(config.OUTPUT_DIR, main_output_folder)
    os.makedirs(main_output_path, exist_ok=True)
    
    # 4. 所有后续操作都使用 main_output_path
    outline_handler.save_outline(outline, output_dir=main_output_path)
    video_handler.cut_videos_by_headings(..., output_dir=main_output_path)
    video_handler.extract_frames_from_videos(..., output_dir=main_output_path)
```

### 大纲保存（outline_handler.py）

```python
def save_outline(outline, output_dir=None):
    """保存大纲到指定目录"""
    outline_path = os.path.join(output_dir, "outline.md")
    # 保存文件...
```

### 视频切片（video_handler.py）

```python
def cut_videos_by_headings(headings, matched_data, output_dir=None):
    """在指定目录下创建 videocut 子目录"""
    videocut_path = os.path.join(output_dir, "videocut")
    os.makedirs(videocut_path, exist_ok=True)
    # 切分视频...
```

### 帧提取（video_handler.py）

```python
def extract_frames_from_videos(videocut_path, output_dir=None):
    """在指定目录下创建 frames_XX 子目录"""
    for video_file in video_files:
        video_name = os.path.splitext(video_file)[0]
        frame_folder = f"frames_{video_name}"
        frame_output_dir = os.path.join(output_dir, frame_folder)
        # 提取帧...
```

## 🎯 设计优势

### 1. **集中管理**
- ✅ 所有相关文件在一个文件夹内
- ✅ 便于整体打包、备份、分享
- ✅ 清理时只需删除一个文件夹

### 2. **清晰的层次结构**
```
大文件夹（运行级别）
├── 文档（大纲）
├── 视频子目录（videocut/）
└── 帧子目录（frames_XX/）
```

### 3. **文件名简洁**
- ✅ 文件夹名包含所有必要信息（视频名+时间戳）
- ✅ 内部文件名简短明了
- ✅ 不需要在每个文件名中重复时间戳

### 4. **易于查找**
- ✅ 按文件夹名排序即按处理时间排序
- ✅ 文件夹名包含视频名，便于识别
- ✅ 最新的结果总在最后

## 💡 使用示例

### 查找最新的处理结果

```python
from pathlib import Path

def find_latest_output(video_name=None):
    """
    查找最新的输出文件夹
    
    Args:
        video_name: 视频名（可选）。如果提供，只查找该视频的结果
    """
    output_dir = Path("output")
    
    if video_name:
        pattern = f"frames_{video_name}_*"
    else:
        pattern = "frames_*"
    
    folders = sorted(output_dir.glob(pattern))
    
    if folders:
        latest = folders[-1]  # 按字母顺序（即时间顺序）的最后一个
        return latest
    
    return None

# 使用示例
latest = find_latest_output("minvideo")
if latest:
    print(f"最新输出: {latest}")
    print(f"大纲文件: {latest / 'outline.md'}")
    print(f"视频切片: {latest / 'videocut'}")
```

### 获取文件夹中的所有视频片段

```python
def get_video_clips(output_folder):
    """获取输出文件夹中的所有视频片段"""
    videocut_dir = Path(output_folder) / "videocut"
    
    if videocut_dir.exists():
        video_files = sorted(videocut_dir.glob("*.mp4"))
        return video_files
    
    return []

# 使用示例
latest = find_latest_output("minvideo")
if latest:
    clips = get_video_clips(latest)
    for clip in clips:
        print(f"视频片段: {clip.name}")
```

### 批量处理多个视频

```python
import config

# 处理视频1
config.INPUT_VIDEO_PATH = "input_video/video1.mp4"
# 运行 main.py
# 输出：output/frames_video1_20251006_103000/

# 处理视频2
config.INPUT_VIDEO_PATH = "input_video/video2.mp4"
# 运行 main.py
# 输出：output/frames_video2_20251006_103530/

# 结果：每个视频的所有输出都独立存储
```

### 打包分享结果

```python
import shutil

def package_results(output_folder, target_zip):
    """将输出文件夹打包为 ZIP"""
    folder_path = Path(output_folder)
    
    if folder_path.exists():
        # 创建 ZIP 文件（不含扩展名）
        shutil.make_archive(
            str(Path(target_zip).with_suffix('')),
            'zip',
            folder_path.parent,
            folder_path.name
        )
        print(f"已打包到: {target_zip}")

# 使用示例
latest = find_latest_output("minvideo")
if latest:
    package_results(latest, "minvideo_results.zip")
```

### 清理旧结果（保留最近N个）

```python
def cleanup_old_results(keep_latest=3, video_name=None):
    """
    删除旧的输出文件夹，只保留最新的N个
    
    Args:
        keep_latest: 保留最近多少个结果
        video_name: 视频名（可选）
    """
    output_dir = Path("output")
    
    if video_name:
        pattern = f"frames_{video_name}_*"
    else:
        pattern = "frames_*"
    
    folders = sorted(output_dir.glob(pattern))
    
    # 删除除了最新N个之外的所有文件夹
    for folder in folders[:-keep_latest]:
        print(f"删除旧输出: {folder}")
        shutil.rmtree(folder)

# 使用示例
cleanup_old_results(keep_latest=3, video_name="minvideo")
```

## 📝 日志输出示例

运行 `main.py` 时的日志：

```
============================================================
开始处理流程 - 时间戳: 20251006_103000
视频文件: minvideo
输出目录: output/frames_minvideo_20251006_103000
============================================================

--- 步骤 1: 开始处理ASR数据 ---
检测到新格式（Paraformer V2），共 89 个句子
--- ASR数据处理完成 ---

--- 步骤 2: 开始生成LLM大纲 ---
--- LLM大纲生成完成 ---

--- 步骤 3: 正在将大纲保存到 output/frames_minvideo_20251006_103000/outline.md ---
--- 大纲保存成功 ---

--- 步骤 5: 正在生成详细大纲文件到 output/frames_minvideo_20251006_103000/detailed_outline.md ---
--- 详细大纲生成成功 ---

--- 步骤 6: 开始根据大纲切分视频 ---
视频片段将保存到: output/frames_minvideo_20251006_103000/videocut
--- 视频切分完成，共生成 3 个视频片段 ---

--- 步骤 7: 开始从视频片段中提取帧 ---
从目录读取视频文件: output/frames_minvideo_20251006_103000/videocut
找到 3 个视频文件
正在从 '01_项目架构图.mp4' 提取帧到 'output/frames_minvideo_20251006_103000/frames_01_项目架构图'...
成功从 '01_项目架构图.mp4' 提取了 120 帧。
--- 帧提取完成，总共提取了 350 帧 ---

============================================================
处理流程完成 - 时间戳: 20251006_103000
============================================================
```

## 🔍 配置说明

在 `config.py` 中修改输入视频：

```python
# 当前配置
INPUT_VIDEO_PATH = os.path.join(PROJECT_ROOT, 'input_video', 'minvideo.mp4')

# 处理不同视频只需修改这一行
INPUT_VIDEO_PATH = os.path.join(PROJECT_ROOT, 'input_video', '你的视频.mp4')
```

输出将自动生成到：`output/frames_你的视频_时间戳/`

## 📚 相关文档

- [CONFIG_配置说明.md](./CONFIG_配置说明.md) - 配置文件说明
- [DATA_PROCESSOR_V2_说明.md](./DATA_PROCESSOR_V2_说明.md) - 数据处理说明
- [ASR_PARAFORMER_V2_说明.md](../../ASR_PARAFORMER_V2_说明.md) - ASR 引擎说明

## 📮 技术支持

如有问题或建议，请提交 Issue。

