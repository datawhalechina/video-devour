# å¸§æå–æ–‡ä»¶ç»“æ„è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

`video_handler.py` ä¸­çš„ `extract_frames_from_videos()` å‡½æ•°å·²æ›´æ–°ï¼Œç°åœ¨æå–çš„å¸§æ–‡ä»¶ä¼šä¿å­˜åœ¨åŒ…å«æ—¶é—´æˆ³çš„æ¯æ–‡ä»¶å¤¹ä¸­ã€‚

## ğŸ“ æ–°çš„æ–‡ä»¶ç»“æ„

### ç›®å½•å‘½åè§„åˆ™

æ¯æ–‡ä»¶å¤¹å‘½åæ ¼å¼ï¼š`frames_è§†é¢‘å_æ—¶é—´æˆ³`

- `frames`: å›ºå®šå‰ç¼€
- `è§†é¢‘å`: åŸè§†é¢‘ç‰‡æ®µçš„åç§°ï¼ˆä¸å«æ‰©å±•åï¼‰
- `æ—¶é—´æˆ³`: æå–æ—¶çš„æ—¶é—´æˆ³ï¼ˆæ ¼å¼ï¼š`YYYYMMDD_HHMMSS`ï¼‰

### ç¤ºä¾‹ç»“æ„

å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹è§†é¢‘ç‰‡æ®µï¼š
- `01_é¡¹ç›®æ¶æ„å›¾.mp4`
- `02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—.mp4`
- `03_çŸ¥è¯†åº“é—®ç­”æµç¨‹.mp4`

æå–å¸§åçš„æ–‡ä»¶ç»“æ„ï¼š

```
output/
â”œâ”€â”€ frames_01_é¡¹ç›®æ¶æ„å›¾_20251006_103000/
â”‚   â”œâ”€â”€ frame_0001.jpg
â”‚   â”œâ”€â”€ frame_0002.jpg
â”‚   â”œâ”€â”€ frame_0003.jpg
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ frames_02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—_20251006_103000/
â”‚   â”œâ”€â”€ frame_0001.jpg
â”‚   â”œâ”€â”€ frame_0002.jpg
â”‚   â”œâ”€â”€ frame_0003.jpg
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ frames_03_çŸ¥è¯†åº“é—®ç­”æµç¨‹_20251006_103000/
    â”œâ”€â”€ frame_0001.jpg
    â”œâ”€â”€ frame_0002.jpg
    â”œâ”€â”€ frame_0003.jpg
    â””â”€â”€ ...
```

## ğŸ”„ ä¸æ—§ç»“æ„çš„å¯¹æ¯”

### æ—§ç»“æ„ï¼ˆä¹‹å‰ï¼‰

```
output/frames/
â”œâ”€â”€ 01_é¡¹ç›®æ¶æ„å›¾/
â”‚   â”œâ”€â”€ frame_0001.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ 02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—/
â”‚   â”œâ”€â”€ frame_0001.jpg
â”‚   â””â”€â”€ ...
â””â”€â”€ 03_çŸ¥è¯†åº“é—®ç­”æµç¨‹/
    â”œâ”€â”€ frame_0001.jpg
    â””â”€â”€ ...
```

### æ–°ç»“æ„ï¼ˆç°åœ¨ï¼‰

```
output/
â”œâ”€â”€ frames_01_é¡¹ç›®æ¶æ„å›¾_20251006_103000/
â”‚   â”œâ”€â”€ frame_0001.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ frames_02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—_20251006_103000/
â”‚   â”œâ”€â”€ frame_0001.jpg
â”‚   â””â”€â”€ ...
â””â”€â”€ frames_03_çŸ¥è¯†åº“é—®ç­”æµç¨‹_20251006_103000/
    â”œâ”€â”€ frame_0001.jpg
    â””â”€â”€ ...
```

## âœ¨ æ–°ç»“æ„çš„ä¼˜åŠ¿

### 1. **æ—¶é—´å¯è¿½æº¯**
- âœ… æ¯ä¸ªæå–æ‰¹æ¬¡éƒ½æœ‰å”¯ä¸€çš„æ—¶é—´æˆ³
- âœ… ä¾¿äºåŒºåˆ†ä¸åŒæ—¶é—´çš„æå–ç»“æœ
- âœ… æ–¹ä¾¿ç‰ˆæœ¬å¯¹æ¯”å’Œå†å²è¿½è¸ª

### 2. **é¿å…è¦†ç›–**
- âœ… å¤šæ¬¡æå–ä¸ä¼šè¦†ç›–ä¹‹å‰çš„ç»“æœ
- âœ… å¯ä»¥ä¿ç•™å†å²æå–è®°å½•
- âœ… ä¾¿äºæ¯”è¾ƒä¸åŒå‚æ•°çš„æå–æ•ˆæœ

### 3. **æ›´æ¸…æ™°çš„ç»„ç»‡**
- âœ… æ¯ä¸ªè§†é¢‘çš„å¸§æ–‡ä»¶ç‹¬ç«‹å­˜å‚¨
- âœ… æ–‡ä»¶å¤¹åç§°è‡ªåŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯
- âœ… ä¾¿äºæ‰¹é‡å¤„ç†å’Œç®¡ç†

### 4. **ä¾¿äºè‡ªåŠ¨åŒ–**
- âœ… è„šæœ¬å¯ä»¥æ ¹æ®æ—¶é—´æˆ³è‡ªåŠ¨é€‰æ‹©æœ€æ–°æ‰¹æ¬¡
- âœ… ä¾¿äºå®ç°æ¸…ç†æ—§æ–‡ä»¶çš„ç­–ç•¥
- âœ… æ”¯æŒå¹¶è¡Œæå–ï¼ˆä¸åŒæ‰¹æ¬¡äº’ä¸å¹²æ‰°ï¼‰

## ğŸ”§ ä»£ç å®ç°

### å…³é”®ä»£ç ç‰‡æ®µ

```python
from datetime import datetime

def extract_frames_from_videos():
    # ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆæ ¼å¼ï¼šYYYYMMDD_HHMMSSï¼‰
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    for video_file in video_files:
        video_name = os.path.splitext(video_file)[0]
        
        # æ„å»ºæ¯æ–‡ä»¶å¤¹åç§°ï¼šframes_è§†é¢‘å_æ—¶é—´æˆ³
        parent_folder_name = f"frames_{video_name}_{timestamp}"
        frame_output_dir = os.path.join(
            os.path.dirname(config.IMAGE_OUTPUT_DIR), 
            parent_folder_name
        )
        
        # åˆ›å»ºç›®å½•å¹¶æå–å¸§
        os.makedirs(frame_output_dir, exist_ok=True)
        # ... ffmpeg æå–é€»è¾‘
```

### æ—¶é—´æˆ³æ ¼å¼

- æ ¼å¼ï¼š`YYYYMMDD_HHMMSS`
- ç¤ºä¾‹ï¼š`20251006_103000`ï¼ˆ2025å¹´10æœˆ6æ—¥ 10:30:00ï¼‰
- ä¼˜ç‚¹ï¼š
  - æ˜“äºé˜…è¯»
  - æ–‡ä»¶ç³»ç»Ÿå‹å¥½ï¼ˆæ— ç‰¹æ®Šå­—ç¬¦ï¼‰
  - å¯æ’åºï¼ˆæŒ‰å­—æ¯é¡ºåºå³æ—¶é—´é¡ºåºï¼‰

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ—¥å¸¸ä½¿ç”¨
```bash
# è¿è¡Œä¸»æµç¨‹
python backend/algorithm/main.py

# ç»“æœè‡ªåŠ¨ä¿å­˜åˆ°å¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å¤¹
output/frames_01_è§†é¢‘å_20251006_103000/
```

### åœºæ™¯ 2ï¼šå‚æ•°å¯¹æ¯”
```bash
# ç¬¬ä¸€æ¬¡æå–ï¼ˆfps=1ï¼‰
# è¾“å‡ºï¼šoutput/frames_01_è§†é¢‘å_20251006_103000/

# ä¿®æ”¹å‚æ•°åå†æ¬¡æå–ï¼ˆfps=2ï¼‰
# è¾“å‡ºï¼šoutput/frames_01_è§†é¢‘å_20251006_103530/

# ä¸¤ä¸ªç‰ˆæœ¬çš„ç»“æœéƒ½ä¿ç•™ï¼Œä¾¿äºå¯¹æ¯”
```

### åœºæ™¯ 3ï¼šæ‰¹é‡å¤„ç†
```python
# æŸ¥æ‰¾æœ€æ–°çš„å¸§æ–‡ä»¶å¤¹
import glob
from pathlib import Path

output_dir = Path("output")
frame_folders = sorted(output_dir.glob("frames_01_*"))
latest_folder = frame_folders[-1]  # æŒ‰æ—¶é—´æˆ³æ’åºåçš„æœ€åä¸€ä¸ª

print(f"ä½¿ç”¨æœ€æ–°çš„å¸§æ–‡ä»¶å¤¹: {latest_folder}")
```

## ğŸ› ï¸ é…ç½®è¯´æ˜

### ç›¸å…³é…ç½®é¡¹

åœ¨ `config.py` ä¸­ï¼š

```python
# è¾“å‡ºç›®å½•é…ç½®
OUTPUT_DIR = "output"
IMAGE_OUTPUT_DIR = os.path.join(OUTPUT_DIR, "frames")  # ä»…ç”¨äºå‚è€ƒ

# å®é™…çš„å¸§æ–‡ä»¶ä¿å­˜åœ¨ï¼š
# output/frames_è§†é¢‘å_æ—¶é—´æˆ³/
```

### æ³¨æ„äº‹é¡¹

1. **æ—¶é—´æˆ³ä¸€è‡´æ€§**
   - åŒä¸€æ‰¹æ¬¡çš„æ‰€æœ‰è§†é¢‘ä½¿ç”¨ç›¸åŒçš„æ—¶é—´æˆ³
   - æ—¶é—´æˆ³åœ¨å‡½æ•°å¼€å§‹æ—¶ç”Ÿæˆä¸€æ¬¡

2. **è·¯å¾„æ„å»º**
   - ä½¿ç”¨ `os.path.dirname(config.IMAGE_OUTPUT_DIR)` è·å– output ç›®å½•
   - ç¡®ä¿åœ¨æ­£ç¡®çš„çˆ¶ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹

3. **æ–‡ä»¶åè§„èŒƒ**
   - è§†é¢‘åä¸­çš„ç‰¹æ®Šå­—ç¬¦å·²åœ¨åˆ‡åˆ†æ—¶æ¸…ç†
   - å¸§æ–‡ä»¶åä¿æŒ `frame_0001.jpg` æ ¼å¼

## ğŸ“ æ—¥å¿—è¾“å‡º

æå–è¿‡ç¨‹ä¸­çš„æ—¥å¿—ç¤ºä¾‹ï¼š

```
2025-10-06 10:30:00 - INFO - --- æ­¥éª¤ 7: å¼€å§‹ä»è§†é¢‘ç‰‡æ®µä¸­æå–å¸§ ---
2025-10-06 10:30:00 - INFO - æ­£åœ¨ä» '01_é¡¹ç›®æ¶æ„å›¾.mp4' æå–å¸§åˆ° 'output/frames_01_é¡¹ç›®æ¶æ„å›¾_20251006_103000'...
2025-10-06 10:30:05 - INFO - æˆåŠŸä» '01_é¡¹ç›®æ¶æ„å›¾.mp4' æå–äº† 120 å¸§ã€‚
2025-10-06 10:30:05 - INFO - å¸§å·²ä¿å­˜åˆ°: output/frames_01_é¡¹ç›®æ¶æ„å›¾_20251006_103000
2025-10-06 10:30:05 - INFO - æ­£åœ¨ä» '02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—.mp4' æå–å¸§åˆ° 'output/frames_02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—_20251006_103000'...
2025-10-06 10:30:12 - INFO - æˆåŠŸä» '02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—.mp4' æå–äº† 85 å¸§ã€‚
2025-10-06 10:30:12 - INFO - å¸§å·²ä¿å­˜åˆ°: output/frames_02_å¾®è°ƒæ¨¡å—ä¸Promptä¼˜åŒ–æ¨¡å—_20251006_103000
2025-10-06 10:30:12 - INFO - --- å¸§æå–å®Œæˆï¼Œæ€»å…±æå–äº† 205 å¸§ ---
```

## ğŸ” åç»­å¤„ç†

### å¦‚ä½•ä½¿ç”¨æå–çš„å¸§

å¦‚æœéœ€è¦åœ¨ `image_processor.py` ä¸­å¤„ç†å¸§æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

```python
import glob
from pathlib import Path

def find_latest_frames():
    """æŸ¥æ‰¾æœ€æ–°çš„å¸§æ–‡ä»¶å¤¹"""
    output_dir = Path("output")
    frame_folders = sorted(output_dir.glob("frames_*"))
    
    if not frame_folders:
        return []
    
    # æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæ–‡ä»¶å¤¹åå·²åŒ…å«æ—¶é—´æˆ³ï¼‰
    return frame_folders

def process_frames_by_video(video_name):
    """å¤„ç†ç‰¹å®šè§†é¢‘çš„å¸§"""
    output_dir = Path("output")
    # æŸ¥æ‰¾è¯¥è§†é¢‘çš„æ‰€æœ‰æ‰¹æ¬¡
    pattern = f"frames_{video_name}_*"
    matching_folders = sorted(output_dir.glob(pattern))
    
    if matching_folders:
        # ä½¿ç”¨æœ€æ–°çš„æ‰¹æ¬¡
        latest_folder = matching_folders[-1]
        print(f"å¤„ç†å¸§æ–‡ä»¶å¤¹: {latest_folder}")
        
        # è·å–æ‰€æœ‰å¸§æ–‡ä»¶
        frames = sorted(latest_folder.glob("frame_*.jpg"))
        return frames
    
    return []
```

## ğŸ§¹ æ¸…ç†ç­–ç•¥

### å»ºè®®çš„æ¸…ç†è„šæœ¬

```python
from pathlib import Path
import shutil
from datetime import datetime, timedelta

def cleanup_old_frames(days=7):
    """
    åˆ é™¤è¶…è¿‡æŒ‡å®šå¤©æ•°çš„å¸§æ–‡ä»¶å¤¹
    
    Args:
        days: ä¿ç•™æœ€è¿‘å¤šå°‘å¤©çš„æ•°æ®
    """
    output_dir = Path("output")
    frame_folders = output_dir.glob("frames_*")
    
    cutoff_date = datetime.now() - timedelta(days=days)
    
    for folder in frame_folders:
        # ä»æ–‡ä»¶å¤¹åæå–æ—¶é—´æˆ³
        parts = folder.name.split('_')
        if len(parts) >= 3:
            try:
                timestamp_str = f"{parts[-2]}_{parts[-1]}"
                folder_date = datetime.strptime(timestamp_str, "%Y%m%d_%H%M%S")
                
                if folder_date < cutoff_date:
                    print(f"åˆ é™¤æ—§æ–‡ä»¶å¤¹: {folder}")
                    shutil.rmtree(folder)
            except ValueError:
                print(f"æ— æ³•è§£ææ—¶é—´æˆ³: {folder.name}")

# ä½¿ç”¨ç¤ºä¾‹
cleanup_old_frames(days=7)  # åªä¿ç•™æœ€è¿‘7å¤©çš„æ•°æ®
```

## ğŸ“® æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issueã€‚

